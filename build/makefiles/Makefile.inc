OBJS = $(SOBJS:.o=.o)
DEBUG_OBJS = $(SOBJS:.o=.debug.o)
MEMSAN_OBJS = $(SOBJS:.o=.memsan.o)
UBSAN_OBJS = $(SOBJS:.o=.ubsan.o)
SCAN_OBJS = $(SOBJS:.o=.scan.o)
DS = $(SOBJS:.o=.d)

# Autogenerated dependencies
-include $(OBJ)/$(SUB)/depend.mk

$(OBJ)/%.o: $(SRC)/%.c
	$(CC) -c $(CFLAGS) -I$(INC) $(DEFINES) $(OPTIMIZED_FLAGS) $(PROJECT_INCLUDE) $< -o $@
	
$(OBJ)/%.o: $(SRC)/%.cpp
	$(CXX) -c $(CXXFLAGS) -I$(INC) $(DEFINES) $(OPTIMIZED_FLAGS) $(PROJECT_INCLUDE) $< -o $@

$(OBJ)/%.debug.o: $(SRC)/%.c
	$(CC) -c $(CFLAGS) -I$(INC) $(DEFINES) $(PROJECT_INCLUDE) $(DEBUG_FLAGS) $< -o $@
	
$(OBJ)/%.debug.o: $(SRC)/%.cpp
	$(CXX) -c $(CXXFLAGS) -I$(INC) $(DEFINES) $(PROJECT_INCLUDE) $(DEBUG_FLAGS) $< -o $@

$(OBJ)/%.memsan.o: $(SRC)/%.cpp
	$(CXX) -c $(CXXFLAGS) -I$(INC) $(DEFINES) $(PROJECT_INCLUDE) $(DEBUG_FLAGS) $(MEMSAN_FLAGS) $< -o $@

$(OBJ)/%.ubsan.o: $(SRC)/%.cpp
	$(CXX) -c $(CXXFLAGS) -I$(INC) $(DEFINES) $(PROJECT_INCLUDE) $(DEBUG_FLAGS) $(UBSAN_FLAGS) $< -o $@

$(OBJ)/%.scan.o: $(SRC)/%.cpp
	$(SCAN) $(_CXX) -c $(CXXFLAGS) -I$(INC) $(DEFINES) $(PROJECT_INCLUDE) $(DEBUG_FLAGS) $< -o $@

$(OBJ)/%.d: $(SRC)/%.c
	$(CC) -MM $(CFLAGS) -I$(INC) $(DEFINES) $(OPTIMIZED_FLAGS) $(PROJECT_INCLUDE) $< -o $@
	echo "include $@" >> $(OBJ)/$(SUB)/depend.mk
	
$(OBJ)/%.d: $(SRC)/%.cpp
	$(CXX) -MM $(CXXFLAGS) -I$(INC) $(DEFINES) $(OPTIMIZED_FLAGS) $(PROJECT_INCLUDE) $< -o $@
	echo "include $@" >> $(OBJ)/$(SUB)/depend.mk

%.a: $(OBJS)
	$(AR) $(ARFLAGS) $@ $(OBJS)
	$(RANLIB) $@

%.debug.a: $(DEBUG_OBJS)
	$(AR) $(ARFLAGS) $@ $(DEBUG_OBJS)
	$(RANLIB) $@

%.memsan.a: $(MEMSAN_OBJS)
	$(AR) $(ARFLAGS) $@ $(MEMSAN_OBJS)
	$(RANLIB) $@

.PHONY: suball
suball:
	@for dir in $(SUBDIRS); do \
		echo Making stuff in $$dir; \
		if $(MAKE) -C $$dir all; then \
			true; \
		else \
			exit 1; \
		fi; \
	done;

.PHONY: subclean
subclean:
	@for dir in $(SUBDIRS); do $(MAKE) -C $$dir clean; done;

.PHONY: subformat
subformat:
	@for dir in $(SUBDIRS); do $(MAKE) -C $$dir format; done;


$(TARGET) : $(OBJS) $(DEBUG_OBJS)

dirs : $(OBJ)/$(SUB) $(DS)

$(OBJ)/$(SUB) :
	mkdir -p $@
	touch $@/depend.mk

clean :
	- rm -rf $(OBJ)/$(SUB)

format :
	- $(FORMAT) -i ${SRC}/$(SUB)/*.cpp
	- $(FORMAT) -i ${_INC}/$(SUB)/*.h



